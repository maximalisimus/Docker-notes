
Выводим в веб почтовый домен mail.myunraid.ru
Для этого воспользуемся Nginx Proxy Manager. Переходим в NPM, добавляем почтовый домен и запрашиваем сертификаты.
Добавлять нужно три адреса:

mail.myunraid.ru
autoconfig.myunraid.ru
autodiscover.myunraid.ru

Поиск SSL сертификата в папке NPM
Этот момент настройки отличается от стандартного из документации mailcow, поэтому немного нужно «извратиться».

Мы вывели наш почтовый домен в веб, получили для него SSL сертификаты, но они лежат только в папке NPM, а нам нужно, чтоб они были продублированы в директории mailcow.

В NPM сертификаты названы «по-своему», с типом 456897.conf, т.е. «цифра.conf» и нужно найти, какая цифра у нашего домена mail.myunraid.ru.

Итак, идем в директорию NPM. По пути:

/mnt/user/appdata/npm/data/nginx/proxy_host/
Теперь надо методом перебора найти наш *.conf файл относящийся к почтовому домену.

По логике, самый последний запрашиваемый нами сертификат — это самое большое число в названии +.conf.

Пример нужного сертификата:

Добавляем SSL сертификаты в папку mailcow
Теперь, когда мы нашли, под каким номером, нужный нам сертификат, переходим в его папку, по пути.
У меня он, под номером «3«.

/mnt/user/appdata/npm/letsencrypt/archive/npm-3/
Во втором окне файл менеджера, открываем директорию в mailcow.

/mnt/user/appdata/mailcow/mailcow-dockerized/data/assets/ssl/
Теперь нужно переместить и переименовать файлы fullchain1.pem и privkey1.pem, в директорию */ssl, с заменой на файлы cert.pem, key.pem.

Через терминал, выполним:

Команда 1

cp /mnt/user/appdata/npm/letsencrypt/archive/npm-3/fullchain1.pem /mnt/user/appdata/mailcow/mailcow-dockerized/data/assets/ssl/cert.pem
Команда 2

cp /mnt/user/appdata/npm/letsencrypt/archive/npm-3/privkey1.pem /mnt/user/appdata/mailcow/mailcow-dockerized/data/assets/ssl/key.pem
Перемещения будут выглядеть следующим образом:

Сертификаты действительны 3 месяца, поэтому лучше сделать скрипт и настроить их перемещение по крону.

Дополнительные записи DNS
Для того, чтоб письма наши не попадали в спам, нам нужно сделать дополнительные DNS записи.

Записи делаются на сайте вашего регистратора домена, в админ панели. Там же, где мы делали «MX» запись.

Из официально документации следует, что есть два типа настроек DNS, минимальные и полные.

Мы будем описывать полные настройки:

Записи в кабинете администрирования домена
Переходим в личный кабинет, и делаем все эти записи.
Приведу скриншот двух записей, остальные нужно сделать также, по аналогии.

Записи DKIM, SPF and DMARC
В документации, также указываются записи DKIM, SPF и DMARC, это также очень важные записи, и нам нужно их сделать обязательно.

Опять же, в настройках администрирования домена, вносим эти записи.
Первая запись, это SPF «v=spf1 a mx ip4:вашIP ~all»
Вторая запись DMARC «v=DMARC1; p=quarantine; sp=quarantine».

И последняя запись DKIM:

Меню «Конфигурация«, в выпадающем списке «Настройка сервера«

Далее:

Mailcow - поднимаем свой почтовый сервер на Unraid 6.8.3 48
«Глобальные настройки«, «ARC/DKIM ключи«

В поле «Домен/ы» пишем наш домен, «Длина ключа«, выбираем 1024, и жмем «Добавить«:

Если у вас, все аналогично, то значит все сделано верно и будет работать. Если возникают ошибки в статусах, то необходимо снова проверить записи DNS.

На TLSA не обращаем внимание, так как очень мало регистраторов доменов, предоставляют возможность сделать TLSA запись. Но и без нее, все будет отлично.
















