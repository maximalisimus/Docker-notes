

/etc/dnsmasq/

# 0.base.conf

domain-needed
bogus-priv
no-hosts
keep-in-foreground
no-resolv
expand-hosts
server=8.8.8.8
server=8.8.4.4



# 1.eureka.conf

address=/001.eureka.storytel/10.10.10.21
address=/002.eureka.storytel/10.10.10.22
address=/003.eureka.storytel/10.10.10.23
txt-record=txt.global.eureka.storytel,sweden.eureka.storytel
txt-record=txt.sweden.eureka.storytel,10.10.10.21,10.10.10.22,10.10.10.23


# 2.etcd.conf

address=/001.etcd.storytel/10.10.10.21
address=/002.etcd.storytel/10.10.10.22
address=/003.etcd.storytel/10.10.10.23



docker run --name dnsmasq --cap-add=NET_ADMIN --net=host -v /etc/dnsmasq:/etc/dnsmasq storytel/dnsmasq



version: '2'
services:
  dns:
    restart: always
    image: strm/dnsmasq
    volumes:
      - ./dnsmasq.conf:/etc/dnsmasq.conf
    ports:
      - "53:53/udp"
    cap_add:
      - NET_ADMIN




/etc/dnsmasq.conf

Самое первое, что необходимо, — это название домена

domain=mydomain.com
Для определенной подсети можно указать отдельное имя домена:

domain=fin.mydomain.com,192.168.1.0/24

И точно так же можно указать имя домена для интервала адресов:

domain=fin.mydomain.com,192.168.1.10,192.168.1.30

Основная функция DNS-сервера — это преобразование доменных имен в IP-адреса и наоборот, 
но DNS-серверов даже в локальной сети может быть несколько. 
Поэтому может потребоваться указать для определенных доменов адреса 
DNS-серверов, на которые должны отравляться запросы:

server=/remoteoffice.org/192.168.3.10
Аналогично указывается сервер для обратной зоны:

server=/3.168.192.in-addr.arpa/192.168.3.1

В конфигурационном файле также можно указать соответствие имени IP-адресу.

Запись типа A  в прямой зоне DNS (сопоставляющей IP-адрес запрошенному имени):

address=/extdomain.net/127.0.0.1
На любое имя хоста *.extdomain.net возвращается адрес 127.0.0.1.

Запись типа CNAME:

cname=sambaserver,smb

Эта запись создает алиас для локального имени sambaserver, чтобы к нему можно было обращаться по более короткому имени smb.

По умолчанию dnsmasq использует файл /etc/hosts для сопоставления имен хостов IP-адресам, но это тоже можно изменить. 
Если вы не хотите использовать /etc/hosts, вы можете указать это при помощи опции

no-hosts
Если же вы хотите использовать совместно с /etc/hosts еще один файл аналогичной структуры, для этого есть опция

addn-hosts=/path/to/file

Кроме задания собственных записей DNS можно изменять информацию, получаемую 
от внешних DNS-серверов путем подмены полученного IP-адреса. Для замены одного адреса:

alias=1.2.3.4,5.6.7.8
Если при запросе доменного имени от внешнего DNS-сервера мы получим IP-адрес 1.2.3.4, 
то мы подменим его на адрес 5.6.7.8. Можно осуществлять подмену целыми подсетями:

alias=1.2.3.0,5.6.7.0,255.255.255.0
Такая запись подменит любой адрес из подсети 1.2.3.0/24 на адрес из подсети 5.6.7.0/24. 
Если же вам необходимо подменять определенный интервал адресов, то такая возможность тоже есть:

alias=10.0.0.10-10.0.0.40,192.168.0.0,255.255.255.0

Эта запись подменит адреса из интервала 10.0.0.10-10.0.0.40 на адреса 192.168.0.10-192.168.0.40

Для того, чтобы обращения к DNS шли именно на dnsmasq на том же сервере, 
где он сам работает, необходимо указать первой записью в /etc/resolv.conf следующую строку:

nameserver 127.0.0.1

Сам dnsmasq будет игнорировать эту запись, поскольку предполагает, что эта запись обозначает 
его собственный сервис, он начинает использование записей с указанием серверов имен со следующей записи, 
в которой указывается уже внешний DNS-сервер.

Во многих системах /etc/resolv.conf генерируется автоматически при получении адреса от провайдера по DHCP, 
поэтому если просто записать эту строчку руками, при переподключении основного сетевого интерфейса файл 
будет перезаписан и эта строка исчезнет. Этого можно избежать, если раскомментировать в файле /etc/dhcp/dhclient.conf 
(или /etc/dhcp3/dhclient.conf, в зависимости от системы) строчку

prepend domain-name-servers 127.0.0.1;


Тогда даже при получении списка DNS-серверов по DHCP первой строчкой в /etc/resolv.conf будет строчка «nameserver 127.0.0.1».

И еще одна опция, которая может вам пригодиться, если вы хотите использовать свой список DNS-серверов:

resolv-file=/path/to/file


Файл, который указывается в этой опции, должен иметь такую же структуру, как и /etc/resolv.conf. 
При наличии этой опции будет использован указанный файл вместо /etc/resolv.conf. 
И таких записей может быть больше одной.

А если необходимо просто указать несколько DNS-серверов, на которые будут форвардиться запросы, 
это можно сделать при помощи записи нескольких строчек с опцией server:

server=8.8.8.8
server=8.8.4.4
...
server=208.67.222.222
server=208.67.220.220


Вот, в общем, и всё. И не забывайте после изменения настроек рестартовать dnsmasq командой

service dnsmasq reload





vi /etc/dnsmasq.d/cache

cache-size=10000
all-servers
no-negcache

* где:

cache-size — размер кэша (количество хостов).
all-servers — задает поведение, при котором наш сервер будет отправлять запрос всем доступным ему серверам DNS и принимать ответ от того, кто первый ему ответит.
no-negcache — не кэшировать негативные ответы.





# интерфейс, на котором должны отвечать DNS-сервер и DHCP-сервер

interface=eth1

# блокировка DHCP сервера (остается только DNS)

no-dhcp-interface=eth1

# не пересылать простые текстовые запросы (без точки или без части домена)

domain-needed

# никогда не пересылать не маршрутизированные адреса

bogus-priv

# позволять запускать более одного процесса

bind-interfaces

# запрет считывать адреса DNS-серверов с файла resolv.conf

no-resolv

# отключение отслеживание изменения файла /etc/resolv.conf

# или другого файла выполняющего его функцию

no-poll


# адреса верхних DNS-серверов (прописаны google OpenDNS)

server=8.8.8.8

server=8.8.4.4

# пересылать запрос сразу на все вышестоящие DNS серверы

all-servers

# для защиты от DNS атак необходимо запретить ответы от вышестоящих

# DNS серверов с IP адресами компьютеров локальной сети:

stop-dns-rebind

# очистка DNS-кэша при перезапуске сервиса

clear-on-reload

# отключаем кеширование ошибочных DNS запросов,

no-negcache

# логирование

log-queries

log-facility=/var/log/dnsmasq-queries.log










